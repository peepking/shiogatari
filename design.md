## 目的と概要

- ブラウザのみで動作するシングルページのTRPG風シミュレーション。`index.html` が `styles.css` と `main.js`（ES Modules）を読み込み、ビルド工程なしで起動する。
- エントリーポイントは `main.js` → `ui.js`。`ui.js` が初期状態の作成、モジュール間の連携、UIバインドと同期を担う。
- ローカルストレージにスナップショットを保存し、起動時に復元できる。

## 技術スタックと構成

- プレーンな HTML/CSS/JavaScript（ES Modules）。マップとバトルは `<canvas>` に直接描画。
- 外部依存は ESLint のみ（開発用）。ゲームロジックや描画はすべてローカル実装。
- 主要画像は `image/` 配下の GIF/PNG を直接参照。

## 主なモジュール

- `ui.js`: 全体オーケストレーション。ボタン/モーダルのバインド、状態同期、ログ/出力の更新、初期データシード。
- `dom.js`: 画面要素参照（`elements`）とログ/トースト/確認ダイアログ/インラインメッセージのヘルパー。
- `state.js`: ゲーム状態の初期化・保持（資産・時間・モード・依頼・勢力など）と日付進行の基本処理。
- `storage.js`: `localStorage` への保存/復元。`snapshotWorld()` と組み合わせ、戦闘中や遭遇中は保存をスキップ。
- `map.js`: 50×50（ズーム9×9）のマップ生成（種は固定 2025）、拠点生成、ピン管理、キャンバス描画、世界スナップショットの保存/復元。
- `actions.js`: 移動/待機/入出場、遭遇判定、敵編成生成、移動系ランダムイベント投入、戦時行動の即時処理。
- `time.js`: 1日単位の進行に伴う維持費/食料消費、週次の支持度変動、戦況ドリフト、災いイベントのスケジュール処理。
- `supplies.js`: 物資定義・上限計算・価格算出・需要/在庫の生成と更新、破棄モーダルの描画/操作。
- `troops.js`: 兵種定義・上限計算・雇用/解雇・人数増減・レベルアップ、部隊モーダルの描画/操作。
- `quests.js`: 依頼/神託/賞金首/海賊/貴族/戦時依頼の生成・受注・完了判定、期限管理、報酬反映。
- `questUtils.js`: ダイス/距離計算、敵人数アンカー補間、ターゲット座標のランダム選択（海/討伐）。
- `battle.js`: バトルシミュレーション（10×10固定盤面、最大20部隊）。編成/フォーメーション/作戦設定、進行/描画、結果集計とコールバック。
- `marketUI.js`: 物資取引・船取引・イベント取引用モーダルの描画と計算、確認処理。
- `hireUI.js`: 雇用モーダルの描画・入力・確定処理。
- `panelUI.js`: 資産表示、勢力/貴族パネル描画、マップ表示切替のバインド。
- `questUI.js`: 依頼一覧カードと依頼モーダルの描画/更新、折りたたみ状態の保持。
- `faction.js`: 勢力状態（関係・支持度・戦況スコア・前線）の管理、好感度/名誉家臣処理、日次/週次のドリフトとイベント投入。
- `events.js`: 汎用イベントキューとモーダル表示、アクション分岐。
- `rules.js`: 状況×出目のテキスト生成（兆し/強度/同行者運命など）と一時状態 `pending` の制御。
- `lore.js`: 勢力/貴族/兆しテーブルなどのデータ定義。
- `constants.js`・`util.js`: モード表示やラベル、ユーティリティ（日時、クランプ、ラベル表示など）。

## データモデル

- `state`（`state.js`）が単一ソース。主なプロパティ:
  - 資産: `ships`、`troops`（兵種→レベル→人数の連想配列）、`faith`、`supplies`、`funds`、`fame`、`silence`。
  - 時間/モード: `year`/`season`/`day`、`modeLabel`（`MODE_LABEL`）、`mapMode`（`full`/`zoom`）、`mapPinsVisible`。
  - 進行: `lastRoll`/`lastResultText`、`eventQueue`/`eventSeq`、`pendingEncounter`（敵編成・地形・勢力・依頼紐付け）、`encounterProgress`/`encounterThreshold`。
  - クエスト: `quests`（拠点ごとの候補、`active`、期限管理用フィールド）、`nobleQuests`、`lastPrayerSeason`、`quests.seeded` など。
  - 勢力: `factionState`（勢力ごとの態度/戦争状態）、`warLedger`（戦況スコアと前線リスト）、`relationScores`、`factionAttitudes`、`honorFactions`、`nobleFavor`、`playerFactionId`。
  - その他: `position`/`selectedPosition`、`travelEventCooldown`、`eventTrade`、`refugeeEscort`、`honorInviteLog`。
- `pending`（`state.js`）はダイス結果からの二段階決定用の一時領域（強度/同行者運命/方向など）。
- `mapData`（`map.js`）はセルごとの地形/建物/拠点参照を持つ 2D 配列。`settlements` に拠点情報（ID/座標/種別/需要/在庫/勢力/支持度/特産品など）を保持。
- セーブデータは `state` と `snapshotWorld()` の組み合わせを JSON 化し、簡易ハッシュを付与して改竄検知。

## 時間進行とリソース消費

- 1季節＝30日、1年＝4季節。`advanceDayWithEvents` が日数を進めつつ連動イベントを処理。
- 食料消費: 10日/20日/30日に `totalTroops/4` を消費。足りない分は人数比で損耗（安全上限あり）。
- 維持費: 季節が変わるごとに兵種ごとの維持費を合算し、資金不足分を損耗として按分。
- 週次（7日ごと）に支持度ドリフト、日次で戦況ドリフトと関係ドリフトを実行。名誉家臣招待は日次抽選（名声/好感度/クールダウン条件付き）。
- 災い（オーメン）はスケジュール管理し、発生日に遭遇戦か損耗イベントを発火。

## マップ・移動・遭遇

- マップ生成は疑似乱数（線形合同法）を用い島/浅瀬/山などを配置。拠点名は接頭語+語幹+村/街の組合せで重複回避。
- 表示は全体/ズームの2モード。ピンは依頼/神託/移動/補給などの種類別に形状/色/優先度を持ち、`mapPinsVisible` で一括表示切替。
- `isValidMove` で隣接1マスかつ所持上限未超過をチェック。`moveToSelected` が移動/待機を実行し、日数進行や遭遇判定を呼ぶ。
- エンカウント閾値は 10〜15（`resetEncounterMeter` で決定）。進捗が閾値に達すると `startTravelEncounter` で敵編成生成・戦闘準備モードへ遷移。拠点に入るとリセット。
- `buildEnemyFormation` は名声・強敵指定・正規軍/海賊プールに応じて編成を乱択し、人数アンカー（通常/強）から総数を補間。
- 移動系ランダムイベント（行商人、救助、密輸、難民、漂流船、裏切り、検問、災い前兆など）は地形と内部フラグに基づき発火率を持つ。発火時は7日間クールダウン。
- 前線半径2マス内では交戦中勢力を優先して遭遇勢力を選択。

## 物資と取引

- 物資は `SUPPLY_ITEMS` 定義（食料+原料5種+加工品5種）。上限は `60 + 45 * ships`。総数は `totalSupplies`。
- 価格: `basePrice * (1 + demand/10) * warMultiplier * supportMultiplier` を小数切り捨て。戦況優勢で安価、劣勢で高騰。支持度高で仕入れ値が微減。
- 需要は拠点種別にバイアス（村=原料/食料高、街=加工品高）、特産品は需要1〜3固定。季節ごとに再生成し、在庫/価格もリフレッシュ。
- `marketUI.js` が取引モーダルを描画し、在庫/所持品のみ表示。資金変動ピルで確認後に反映。船取引は街限定で5000資金/隻。
- 移動イベント用の特別取引（`eventTrade`）も同じ価格計算を再利用し、専用モーダルで処理。

## 部隊と雇用

- 兵種は `TROOP_STATS` に定義（雇用費/維持費/HP/ATK/DEF/SPD/RNG/MOV/地形補正/基礎火力）。上限は `30 + 15 * ships`。
- 雇用枠: 村3枠/街5枠、各枠3人まで、Lv1固定。季節ごとに `refreshSettlementRecruitment` で補充。
- 雇用は `hireUI.js` のモーダルで数量入力→資金変動確認→確定。`addTroops` が既存レベルに加算。
- 解雇は部隊モーダル（`renderTroopModal`）から人数入力→確認→削除。兵種/レベル別に人数を保持し、0になるとキーを削除。
- 戦闘以外の損耗（食料不足/維持費不足/災い）は `applyTroopLosses` で兵種比率に按分。

## 依頼・神託・賞金首/戦時/貴族

- 依頼種別（`QUEST_TYPES`）: 調達/配達、神託（加工奉納/移動/部隊奉納/討伐/強敵討伐）、海賊・賞金首討伐、戦時（防衛/襲撃/小競り合い/補給/護衛/封鎖/停戦）、貴族（補給/斥候/警護/避難/兵站/討伐）、難民護衛など。
- 各拠点に季節ごと3件生成（`ensureSeasonalQuests`）。`questTickDay` が期限減算（通常30日、神託90日）と季節更新を担当。期限超過は失敗扱いで削除。
- 受注時にマップにピンを立て、依頼一覧カードとモーダルに詳細を表示。完了条件を満たすと「完了」ボタンで報酬（資金/名声/信仰/好感度など）を付与。
- 戦闘型依頼はバトル結果にフック（`completeOracleBattleQuest` など）し、勝利時に達成・敗北で失敗。逃走/降伏は対象依頼を失敗として扱う。
- 神託は季節1件まで（未達成があると新規不可）。賞金首は名声100以上で強編成を抽選。

## 戦闘システム

- 盤面10×10固定、`MAX_SQUADS` 20。1部隊最大10人。BASE_TICK_MS=1000 を速度設定（1/2/4倍）でスケーリングし、最大60ティックで決着。
- 部隊のステータスは兵種ステータスに人数/レベル補正を掛けて計算。地形補正は拠点地形をベースにランダムウェイトで決定（平原/森/山岳/浅瀬/海/甲板）。
- UIカード: 編成（自動配備/クリア/手動出撃・待機/適用）、フォーメーション（バランス/突撃/防御/カスタム保存）、作戦（攻撃方針/距離維持/突撃抑制/速度）。戦闘開始後は編成UIをロック。
- ターゲット選択は兵種デフォルト方針を持ち、作戦カードで全体上書き可。近接探索3マス/遠隔4マス、ターゲット切替にクールダウンを設定。
- 距離維持: 後退/退避はHP閾値（初期30%）で安全地形へ移動しつつ射程維持。突撃抑制は味方先頭からの先行距離で移動量を制限。
- 勝敗判定後、`setBattleEndHandler` で `ui.js` 側に結果を渡し、名声/資金/食料/物資/損耗/拿捕/練度上昇を集計。敗北や撤退時は依頼状態を更新し、通常モードへ戻す。

## 勢力・戦況・貴族

- 勢力定義は `lore.js`（色/態度/貴族リストなど）。`factionState` に態度/関係/戦争フラグ/補給士気を保持し、全勢力間の関係を初期化。
- 戦況は `warLedger.entries` に `factions`（交戦ペア）と `activeFronts`（前線ID/拠点ID/開始日/終了予定/スコア）を保持。`addWarScore`/`addFrontScore` で更新し、`getWarScoreLabel` で表示段階を決定。
- 関係/支持度: `adjustSupport` が拠点×勢力の支持度を変更し、週次ドリフトで中立化。`relationScores` は緊張度の累積で、しきい値を超えると戦争/同盟に遷移。
- 名誉家臣: 名声と好感度条件を満たすとイベントキューに勧誘を投入。受諾で `playerFactionId` を設定し、勢力カードに反映。
- 戦時行動: 前線拠点上でのみ `triggerWarAction` を実行（防衛/襲撃/小競り合い/補給/護衛/封鎖）。戦況スコアと支持度を即時加算。

## 謁見・貴族・戦争の詳細

- 謁見モード（`MODE_LABEL.AUDIENCE`）
  - 貴族が滞在している拠点のみボタン表示。滞在判定は `nobleHome` に一致するかで決定。
  - 操作: 賄賂（`submitBribe`、好感度+⌊金額/100⌋、上限は名誉家臣閾値まで）、仕官（名声100以上＆好感度30以上で名誉家臣化）、貴族依頼の受注、名誉家臣の辞任、拠点モードへ戻る。
  - 好感度は `adjustNobleFavor` で -100〜100 にクランプし、名誉家臣勧誘判定にも利用。
- 勢力関係
  - `relationScores` が戦争閾値（100）を超えると交戦、同盟閾値（-100）で同盟化。日次の緩和ドリフトで漸次中立へ戻る。
  - 戦況スコアは `warScoreLabel` で「優勢/やや優勢/拮抗/やや劣勢/劣勢」に段階化し、交易価格補正に影響。
  - 支持度（拠点×勢力）は依頼/行動の結果や週次ドリフトで上下し、価格補正にも連動。
- 戦争と前線
  - `seedWarDefaults` が初期の戦争/前線をセット。`tickDailyWar` が日次で前線期間を更新し、戦況を少しずつ進める。
  - 前線拠点にいる場合、戦時アクションボタンが出現。行動は非戦闘で即時解決し、`addWarScore`/`adjustSupport`/`adjustNobleFavor` などを通じて数値を変化させる。
  - 戦時依頼（war_*）は通常の戦闘フローで処理し、勝敗によって戦況・名声が大きく変化する。

## UI同期とイベント処理

- `ui.js` の `syncUI` が資産/モード/クエスト/マップ情報/ボタン活性を一括更新。行動後やモーダル完了後に呼び出す。
- `dom.js` の `pushLog`/`pushToast` で時系列ログとトースト通知を追加。`setOutput` は「状況」カードのタイトル/本文とタグ2つを更新。
- `events.js` のキューは一件ずつモーダル表示し、アクション選択後に消化。移動イベントは `handleTravelEventAction` で専用処理。
- マップホバーやピン表示切替は `wireMapHover`/`wireMapToggle`、勢力/貴族パネルは `wireFactionPanel` が担当。

## セーブ/ロード

- `saveGameToStorage(force=false)` は戦闘中/遭遇中を除き状態と世界スナップショットを保存。ハッシュ不一致やパース失敗時は復元を拒否。
- `loadGameFromStorage` はハッシュ検証後に `resetState`→`restoreWorld`→`state` へのマージを行い、欠損フィールドは各モジュールの `ensure*` で補完。

## ランダム性の扱い

- マップ生成・拠点名・需要/在庫・雇用枠・敵編成・依頼ターゲット・遭遇/イベント判定・名誉家臣勧誘など多数の乱数を使用。
- マップのみシード固定（2025）で再現性あり。それ以外は毎回ランダム。敵人数は名声アンカーを線形補間し、強敵/正規軍フラグでプール切替。
- 食料/維持費不足による損耗は兵種比率で決定し、余りは多い順に配分して恣意性を減らしている。

## 戦闘・行動の詳細仕様

- 戦闘報酬/損失（`processBattleOutcome`）
  - 勝利: 名声 +⌊敵総数/4⌋、資金は `敵総数*20*乱数(0.9~1.1)`（強編成なら×2）、食料は `敵総数*0.5*乱数(0.9~1.1)`（強編成なら×2）、原料/加工品を少数抽選で加算。
  - 敗北: 名声を同量減算。資金と全物資を 45〜55% 失う。
  - 拿捕: 撃破済み敵ユニット1人につき5%で1人捕虜。行商人襲撃/救助/密輸/難民系イベントでは捕虜抽選+3回のボーナス。強襲系イベント勝利時は30%で船+1。
  - 練度: 撃破数に応じ `levelUpTroopsRandom` でランダムにレベル+1。
- 損耗と衛生兵（`calcLosses`）
  - 戦闘終了時HP<=0の味方だけが損耗対象。
  - 衛生兵は人数10まで有効。損耗確率は `0.5 * (1 - min(10,衛生兵数)/10)`。例: 0人で50%損耗、5人で25%、10人で0%。
  - 損耗人数は `round(部隊人数 * 損耗確率)` を兵種ごとに加算し、`applyTroopLosses` で状態に反映。
- 斥候と逃走（`escapeSuccessRate`）
  - 基本30%に、斥候人数の寄与 `70 * (1 - 0.6^斥候数)` を足し、0〜100%にクランプ。斥候10人でほぼ99%に漸近。
  - 戦闘準備UIの逃走ボタンに成功率を表示。
- 海に祈る（`performPrayer`）
  - 信仰10以上かつ季節1回制限。消費量は `floor(faith*0.1)`（0なら不可）。
  - 効果: 資金 `消費 * 10D50`、食料 `消費*2` を獲得し、信仰を消費。海賊への戦況スコアに信仰消費ぶんを加算。
- 船取引と上限
  - 船価格は固定5000。所持船に応じて物資上限 `60+45*船数`、部隊上限 `30+15*船数` が即時更新。
- 雇用枠の更新
  - 村3枠/街5枠を固定保持し、季節更新で各枠の残数だけを `RECRUIT_PER_SLOT=3` にリセット。枠の兵種は拠点生成時に決定し、街は必ずレア枠を1つ含む。

## 拡張時のメモ

- UIに新しい状態を追加する場合は `state` 初期化・保存/復元・`syncUI` 反映の3点を忘れずに調整する。
- 新規行動は `actions.js` から呼ばれるUIバインドを追加し、`pushLog`/`setOutput`/`pushToast` でフィードバックを返す。
- モーダル追加時は `dom.js` に参照を登録し、背景クリックと閉じるボタンの両方で閉じられるようにする。
- バトル関連の変更は `battle.js` と `ui.js` の結果ハンドラ双方を更新し、依頼/戦況への反映漏れを防ぐ。
